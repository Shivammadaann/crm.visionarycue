<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionary Cue Â· Team Dashboards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* (all existing styles â€“ unchanged) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: #0a0f1e;
            min-height: 100vh;
            display: flex;
        }

        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .fade-in { animation: fadeIn 0.4s ease forwards; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.2, 0.9, 0.3, 1) forwards; }
        .scale-in { animation: scaleIn 0.3s ease forwards; }

        #department-dashboard, #gmeet-pane, #pipeline-pane { animation: fadeIn 0.4s ease; }

        /* ===== MODAL ===== */
        .modal-overlay {
            transition: backdrop-filter 0.3s ease, background 0.3s ease;
        }
        .modal-content {
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1), opacity 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* ===== DROPDOWN ===== */
        .filter-dropdown {
            display: block;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            position: absolute;
            background: #1f2a37;
            border-radius: 16px;
            padding: 12px 0;
            min-width: 180px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 15px 30px -10px black;
            border: 1px solid #374151;
        }
        .filter-dropdown.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* ===== TOAST ===== */
        .toast {
            transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1), opacity 0.3s ease;
            transform: translateX(120%);
        }
        .toast.show { transform: translateX(0); }

        /* ===== CARD STYLES ===== */
        .nav-item, .admin-card, .dept-option, .btn, .read-more-btn, .clear-btn, .filter-chip, .source-badge, .status-badge {
            transition: all 0.2s ease;
        }
        .stats-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 28px -8px rgba(0, 0, 0, 0.6);
        }
        tr { transition: background 0.15s ease; }
        .filter-chip { animation: slideUp 0.2s ease; }
        .dept-option:hover {
            transform: scale(1.02) translateY(-4px);
            box-shadow: 0 24px 36px -12px #000000cc;
        }
        .admin-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 30px -10px #00000080;
        }
        .btn-primary, .btn-secondary {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px -6px #2563eb80;
        }
        .btn-primary:active, .btn-secondary:active { transform: translateY(0); }
        .search-wrapper:focus-within, .date-wrapper:focus-within {
            box-shadow: 0 0 0 2px #3b82f640;
            transition: box-shadow 0.2s;
        }
        .filterable-th i { transition: transform 0.2s ease; }
        .filterable-th:hover i { transform: translateY(-50%) rotate(180deg); }
        .pipeline-owner-card {
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s;
        }
        .pipeline-owner-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 24px 32px -14px #000000;
        }
        .nav-item.active {
            background: #2563eb20;
            color: #60a5fa;
            border-left: 3px solid #3b82f6;
            transition: all 0.2s ease;
        }
        .hidden-pane { display: none; }
        .active-pane { display: block; }

        .sidebar { width: 260px; background: #111827; border-right: 1px solid #1f2937; display: flex; flex-direction: column; position: fixed; height: 100vh; color: #e5e7eb; }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid #1f2937; }
        .sidebar-header h2 { font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #60a5fa, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-item { padding: 14px 24px; display: flex; align-items: center; gap: 12px; color: #9ca3af; cursor: pointer; margin: 4px 8px; border-radius: 10px; }
        .nav-item:hover { background: #1f2937; color: white; }
        .admin-info { margin-top: auto; padding: 20px; border-top: 1px solid #1f2937; font-size: 0.9rem; }

        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 24px;
            background: #0f1525;
            min-height: 100vh;
            position: relative;
        }

        #login-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0a0f1e; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #1a2332; border-radius: 24px; padding: 32px; width: 90%; max-width: 500px; }
        .admin-card { background: #242f3f; border-radius: 20px; padding: 30px 20px; text-align: center; cursor: pointer; }

        #dept-select-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f1525;
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .dept-select-card {
            background: #1a2332;
            border-radius: 32px;
            padding: 40px;
            width: 90%;
            max-width: 900px;
            text-align: center;
        }
        .dept-option {
            background: #242f3f;
            border-radius: 28px;
            padding: 40px 20px;
            cursor: pointer;
            transition: 0.25s;
            border: 1px solid #374151;
        }
        .dept-option:hover {
            transform: scale(1.02);
            background: #2d3a4d;
            border-color: #3b82f6;
            box-shadow: 0 20px 30px -10px #00000080;
        }
        .dept-option i { font-size: 2.8rem; margin-bottom: 15px; }
        .dept-option h3 { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .dept-option p { color: #9ca3af; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000000cc; backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #1a2332; border-radius: 24px; padding: 32px; width: 90%; max-width: 650px; max-height: 80vh; overflow-y: auto; color: #e5e7eb; }
        .input-field { width: 100%; padding: 14px 16px; background: #242f3f; border: 1px solid #374151; border-radius: 12px; color: white; margin-bottom: 16px; }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #2d3a4d; color: white; }
        .table-container { background: #1a2332; border-radius: 20px; overflow-x: auto; margin-top: 16px; position: relative; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { text-align: left; padding: 18px 12px; background: #242f3f; color: #9ca3af; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; white-space: nowrap; position: relative; }
        .filterable-th { cursor: pointer; user-select: none; transition: background 0.15s; padding-right: 28px; }
        .filterable-th:hover { background: #2d3a4d; color: white; }
        .filterable-th i { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; opacity: 0.7; transition: transform 0.2s; }
        td { padding: 16px 12px; border-bottom: 1px solid #2d3a4d; color: #e5e7eb; height: 80px; overflow: hidden; vertical-align: middle; }
        .col-name { width: 12%; } .col-email { width: 14%; } .col-phone { width: 11%; } .col-source { width: 9%; } .col-budget { width: 11%; } .col-owner { width: 10%; } .col-stage { width: 8%; } .col-remark { width: 25%; }
        tr:hover { background: #242f3f; }
        .remark-cell { display: flex; align-items: center; justify-content: space-between; gap: 8px; height: 100%; }
        .remark-preview { flex: 1; color: #d1d5db; font-size: 0.85rem; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; white-space: normal; word-break: break-word; max-height: 42px; }
        .read-more-btn { background: #2d3a4d; border: none; color: #93c5fd; font-size: 0.7rem; padding: 6px 10px; border-radius: 30px; cursor: pointer; white-space: nowrap; font-weight: 500; flex-shrink: 0; }
        .read-more-btn:hover { background: #3b4a62; color: white; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .status-hot { background: #7f1d1d; color: #fecaca; }
        .status-warm { background: #854d0e; color: #fef9c3; }
        .status-cold { background: #1e3a8a; color: #bfdbfe; }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #1a2332; border-left: 4px solid #3b82f6; padding: 16px 24px; border-radius: 12px; color: white; display: none; z-index: 3000; }
        .toast.show { display: block; }
        .stats-card { background: #1a2332; border-radius: 16px; padding: 20px; }
        .source-badge { background: #374151; color: #e5e7eb; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; display: inline-block; }
        .filter-bar { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: #1a2332; padding: 16px 20px; border-radius: 40px; margin-bottom: 20px; }
        .search-wrapper { flex: 2; min-width: 240px; display: flex; align-items: center; background: #242f3f; border-radius: 40px; padding: 0 16px; transition: box-shadow 0.2s; }
        .search-wrapper i { color: #6b7280; }
        .search-wrapper input { background: transparent; border: none; padding: 12px 12px; color: white; width: 100%; outline: none; }
        .date-wrapper { display: flex; align-items: center; gap: 8px; background: #242f3f; padding: 6px 16px; border-radius: 40px; transition: box-shadow 0.2s; }
        .date-wrapper label { color: #9ca3af; font-size: 0.9rem; }
        .date-wrapper input[type="date"] { background: transparent; border: none; color: white; padding: 8px 0; font-size: 0.9rem; }
        .date-wrapper input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        .clear-btn { background: #2d3a4d; border-radius: 30px; padding: 8px 18px; color: #d1d5db; font-size: 0.85rem; cursor: pointer; border: none; }
        .clear-btn:hover { background: #3b4a62; transform: scale(0.97); }
        .detail-grid { display: grid; grid-template-columns: 100px 1fr; gap: 12px 10px; margin: 10px 0; }
        .detail-label { color: #9ca3af; }
        .dept-indicator { display: inline-block; background: #1f2a37; padding: 6px 18px; border-radius: 40px; font-size: 1rem; font-weight: 500; margin-left: 15px; }
        .proposal-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .proposal-yes { background: #065f46; color: #d1fae5; }
        .proposal-no { background: #7f1d1d; color: #fee2e2; }
        .filter-chip { background: #2d3a4d; border-radius: 30px; padding: 4px 12px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 6px; margin-right: 8px; color: #bfdbfe; }
        .pipeline-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .pipeline-owner-card { background: #1e2a3a; border-radius: 24px; padding: 22px 20px; border-left: 6px solid; }
        .pipeline-total-card { background: linear-gradient(145deg, #1f2a37, #1a2532); border-radius: 28px; padding: 28px; margin-bottom: 25px; border: 1px solid #3b82f620; }
        .amount-display { font-size: 2rem; font-weight: 700; color: white; }

        /* ===== TIMELINE STYLES ===== */
        .timeline-item {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            position: relative;
        }
        .timeline-item:last-child { margin-bottom: 0; }
        .timeline-badge {
            width: 44px;
            height: 44px;
            background: #2d3a4d;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 2px solid #3b82f6;
            box-shadow: 0 6px 12px -6px #1e3a8a;
        }
        .timeline-badge i { font-size: 1.2rem; color: #93c5fd; }
        .timeline-content {
            background: #1e2a3a;
            border-radius: 18px;
            padding: 16px 20px;
            flex: 1;
            border-left: 4px solid #3b82f6;
        }
        .timeline-date {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .timeline-date i { color: #3b82f6; font-size: 0.7rem; }
        .timeline-text { color: #e5e7eb; line-height: 1.5; white-space: pre-line; }
        .timeline-item:not(:last-child) .timeline-badge::after {
            content: '';
            position: absolute;
            left: 21px;
            top: 48px;
            width: 2px;
            height: calc(100% + 4px);
            background: #374151;
            transform: translateX(-50%);
            z-index: 0;
        }
        .popup-remark-block {
            background: transparent;
            padding: 0;
            margin: 16px 0 8px;
            border-left: none;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 6px;
        }
    </style>
</head>
<body>

<div id="toast" class="toast"><i class="fas fa-info-circle mr-2 text-blue-400"></i><span id="toast-message"></span></div>

<!-- Login Screen (modified to include three cards) -->
<div id="login-screen">
    <div class="login-card scale-in">
        <h1 class="text-3xl font-bold text-center mb-6 text-white">Visionary Cue - Team Dashboard</h1>
        <p class="text-center text-gray-400 mb-8">Select your profile</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Admin Shivam -->
            <div class="admin-card" onclick="showPasswordModal('Shivam', 'Admin')">
                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-crown text-2xl text-blue-400"></i>
                </div>
                <h3 class="text-lg font-bold text-white">Shivam</h3>
                <p class="text-blue-400 text-xs">Administrator</p>
            </div>
            <!-- Team Member Sarthak -->
            <div class="admin-card" onclick="showPasswordModal('Sarthak', 'Team Member')">
                <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-user-tie text-2xl text-green-400"></i>
                </div>
                <h3 class="text-lg font-bold text-white">Sarthak</h3>
                <p class="text-green-400 text-xs">Digital Sales</p>
            </div>
            <!-- Team Member Aabid -->
            <div class="admin-card" onclick="showPasswordModal('Aabid', 'Team Member')">
                <div class="w-16 h-16 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-user text-2xl text-purple-400"></i>
                </div>
                <h3 class="text-lg font-bold text-white">Aabid</h3>
                <p class="text-purple-400 text-xs">Digital Sales</p>
            </div>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div id="password-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-white mb-2">Enter Password</h2>
        <p class="text-gray-400 mb-6" id="password-modal-subtitle"></p>
        <input type="password" id="password-input" class="input-field" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeypress="if(event.key==='Enter') verifyPassword()">
        <div class="flex gap-3">
            <button class="btn btn-secondary flex-1" onclick="closePasswordModal()">Cancel</button>
            <button class="btn btn-primary flex-1" onclick="verifyPassword()">Unlock</button>
        </div>
    </div>
</div>

<!-- Lead Detail Popup with Timeline -->
<div id="lead-popup" class="modal-overlay">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2"><i class="fas fa-user-circle text-blue-400"></i> Lead Details</h2>
        <div id="popup-lead-details" class="detail-grid"></div>
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2"><i class="fas fa-history text-blue-400"></i> Remark Timeline</h3>
            <div id="popup-remark-container" class="popup-remark-block"></div>
        </div>
        <div class="mt-6 flex justify-end">
            <button class="btn btn-secondary" onclick="document.getElementById('lead-popup').classList.remove('active')">Close</button>
        </div>
    </div>
</div>

<!-- Sidebar (unchanged) -->
<div class="sidebar">
    <div class="sidebar-header"><h2>Visionary Cue</h2><p class="text-xs text-gray-500 mt-1" id="sidebar-role-label">Admin Dashboard</p></div>
    <div class="nav-item" onclick="selectDepartment('digital')"><i class="fas fa-mobile-alt"></i><span>Digital Sales</span></div>
    <div class="nav-item" onclick="selectDepartment('abroad')"><i class="fas fa-globe-asia"></i><span>Study Abroad</span></div>
    <div class="nav-item" onclick="selectDepartment('domestic')"><i class="fas fa-home"></i><span>Domestic Sales</span></div>
    <div class="nav-item" onclick="showGMeet()"><i class="fas fa-video"></i><span>G Meet Status</span></div>
    <div class="nav-item" onclick="showPipeline()"><i class="fas fa-chart-line"></i><span>Pipeline</span></div>
    
    <div class="admin-info">
        <div id="current-user-display" class="font-medium text-white mb-1"></div>
        <div id="current-role-display" class="text-xs text-gray-500"></div>
        <button onclick="logout()" class="mt-3 text-sm text-red-400 hover:text-red-300"><i class="fas fa-sign-out-alt mr-1"></i> Logout</button>
    </div>
</div>

<!-- Main Content Area -->
<div class="main-content">
    <!-- Department selection overlay (only for admin) -->
    <div id="dept-select-screen">
        <div class="dept-select-card scale-in">
            <h2 class="text-3xl font-bold text-white mb-3">Welcome, <span id="welcome-user">Admin</span> ðŸ‘‹</h2>
            <p class="text-gray-400 text-lg mb-12">Which department would you like to access?</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="dept-option" onclick="selectDepartment('digital')">
                    <i class="fas fa-mobile-alt text-blue-400"></i>
                    <h3 class="text-white">Digital Sales</h3>
                    <p>Online campaigns & leads</p>
                </div>
                <div class="dept-option" onclick="selectDepartment('abroad')">
                    <i class="fas fa-globe-asia text-green-400"></i>
                    <h3 class="text-white">Study Abroad</h3>
                    <p>International students</p>
                </div>
                <div class="dept-option" onclick="selectDepartment('domestic')">
                    <i class="fas fa-home text-yellow-400"></i>
                    <h3 class="text-white">Domestic Sales</h3>
                    <p>Local programs & coaching</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Dashboard (used by both admin and team members) -->
    <div id="department-dashboard" class="hidden-pane">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 id="dept-dashboard-title" class="text-3xl font-bold text-white">Loading...</h1>
                <p class="text-gray-400 text-sm mt-1"><i class="fas fa-google mr-1"></i> Connected to Google Sheets</p>
            </div>
            <button onclick="exportToExcel()" class="btn btn-primary"><i class="fas fa-download mr-2"></i>Export</button>
        </div>

        <div class="filter-bar">
            <div class="search-wrapper">
                <i class="fas fa-search mr-2"></i>
                <input type="text" id="searchInput" placeholder="Search by name, phone or email..." onkeyup="applyFilters()">
            </div>
            <div class="date-wrapper">
                <label for="dateFilter"><i class="far fa-calendar-alt mr-1"></i>Added after:</label>
                <input type="date" id="dateFilter" onchange="applyFilters()">
            </div>
            <button class="clear-btn" onclick="clearFilters()"><i class="fas fa-times mr-1"></i>Clear all</button>
        </div>

        <div id="active-filter-chip" class="mb-3 text-sm"></div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="dept-stats"></div>

        <div class="table-container" id="table-container">
            <table id="leads-table">
                <colgroup><col class="col-name"><col class="col-email"><col class="col-phone"><col class="col-source"><col class="col-budget"><col class="col-owner"><col class="col-stage"><col class="col-remark"></colgroup>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th id="source-th" class="filterable-th" onclick="toggleDropdown('source')">Source <i class="fas fa-chevron-down"></i></th>
                        <th>Budget</th>
                        <th id="owner-th" class="filterable-th" onclick="toggleDropdown('owner')">Lead Owner <i class="fas fa-chevron-down"></i></th>
                        <th id="stage-th" class="filterable-th" onclick="toggleDropdown('stage')">Stage <i class="fas fa-chevron-down"></i></th>
                        <th>Remark</th>
                    </tr>
                </thead>
                <tbody id="dept-table-body"></tbody>
            </table>

            <!-- Dropdown menus -->
            <div id="source-dropdown" class="filter-dropdown"></div>
            <div id="owner-dropdown" class="filter-dropdown"></div>
            <div id="stage-dropdown" class="filter-dropdown"></div>
        </div>
    </div>

    <!-- G Meet Status Pane -->
    <div id="gmeet-pane" class="hidden-pane">
        <div class="flex justify-between items-center mb-8">
            <div><h1 class="text-3xl font-bold text-white">G Meet Status</h1><p class="text-gray-400 text-sm mt-1">Track all Google Meet sessions</p></div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Lead Owner</th><th>Lead Name</th><th>G Meet Date</th><th>Agenda</th><th>Outcome</th><th>Proposal Shared</th><th>Amount Pitched</th></tr></thead>
                <tbody id="gmeet-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Pipeline Pane -->
    <div id="pipeline-pane" class="hidden-pane">
        <div class="flex justify-between items-center mb-6">
            <div><h1 class="text-3xl font-bold text-white">Pipeline Overview</h1><p class="text-gray-400 text-sm mt-1">Based on "Amount Pitched" in G Meet</p></div>
        </div>

        <div class="pipeline-total-card" id="pipeline-total-container">
            <div class="text-gray-400 text-sm mb-1">Total Pipeline Value</div>
            <div class="amount-display" id="total-pipeline-amount">â‚¹0</div>
            <div class="text-gray-500 text-xs mt-2">from all G Meet opportunities</div>
        </div>

        <h2 class="text-xl font-semibold text-white mb-4">Pipeline by Lead Owner</h2>
        <div class="pipeline-grid" id="pipeline-owner-grid"></div>

        <div class="mt-10">
            <h3 class="text-lg font-medium text-white mb-3">Detailed Pitched Meetings</h3>
            <div class="table-container">
                <table>
                    <thead><tr><th>Lead Owner</th><th>Lead Name</th><th>Amount Pitched</th><th>Date</th><th>Outcome</th></tr></thead>
                    <tbody id="pipeline-detail-table"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== CONFIGURATION â€“ REPLACE WITH YOUR PUBLISHED CSV URLs ====================
// Department sheets (used by admin)
const DIGITAL_SHEET_URL   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR5ZbIinS1M68n2Sq3GQ0pjYn1ufVxFfjXp1OAOP8fSuhXd_mBmuFsRwMTi1b__Z6UXph5Ei7a0HLWB/pub?output=csv';   // Digital Sales (contains leads for multiple owners)
const ABROAD_SHEET_URL    = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQubSCIMcHOg-zY5ehV98ivA-kyBsj2lMQ_wGlpEuoP3KJ5WoN0_AZ76IzQMLRg1yr07c5unl2avzVA/pub?output=csv';   // Study Abroad
const DOMESTIC_SHEET_URL  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQtWNEIwdBAgG4bTjr1Ohq8VCXDLeP8e2eRadjkOML19JlofSCR1x0vor0gqBYs5CeN9etAOjgj-Cbl/pub?output=csv';   // Domestic Sales
// Team member dedicated sheets (must contain leads with owner column = Sarthak / Aabid)
const SARTHAK_SHEET_URL   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcCJfUebUON_9-Qk-RvwW6FlvgMKvzn_BKdNSpuH3gNvB4CyZn_Y1P2foLDWYcgoJcb5-BCmvLqILp/pub?output=csv';   // Sarthak's personal leads
const AABID_SHEET_URL     = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSBFoluGkU2pU5zmlrtjOAN6xZYV4SpAFMMbz4_7QS561F5PnxdaltoVc1msQLmfwfPQ4uk1s-eNATR/pub?output=csv';   // Aabit's personal leads
// Shared GMeet sheet (contains meetings for all owners)
const GMEET_SHEET_URL     = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSwKz7KWKSuhpmcj3uMf77fRV-wI7WDJMmHp9rWj76Ua3AKFB6lB8FCjdKugNpJc9WSk8WgxboRcVv7/pub?output=csv';   // G Meet Status
// ==============================================================================================

// User credentials: passwords (in production use secure auth)
const USERS = {
    'Shivam': { password: 'shivam123', role: 'Admin' },
    'Sarthak': { password: 'sarthak123', role: 'Team Member' },
    'Aabit': { password: 'aabid123', role: 'Team Member' }
};

let currentUser = null, currentRole = null;
let leads = [];               // will hold all leads from loaded sheets
let gmeetMeetings = [];       // will hold all G Meet entries
let activeDepartment = null;

// Filter state
let searchTerm = '';
let filterDate = null;
let columnFilters = { owner: null, source: null, stage: null };
let openDropdown = null;

// Sample fallback data (used if sheets fail to load)
const sampleLeads = [
    { name:'Rahul Verma', email:'rahul@email.com', phone:'9812345678', source:'Instagram', budget:'â‚¹50,000', owner:'Shivam', stage:'Hot', 
      remark:`12 feb\nright now occupied and wants to connect on 14 feb at 11 am..\nfeb 16 right now travelling so wants to connect after 1 week`, department:'digital', dateAdded:'2025-02-12' },
    { name:'Priya Singh', email:'priya@email.com', phone:'8822334455', source:'LinkedIn', budget:'â‚¹25,000', owner:'Sarthak', stage:'Warm', 
      remark:`Called twice, no response. Will try again Monday.`, department:'digital', dateAdded:'2025-02-10' },
    { name:'John Doe', email:'john@email.com', phone:'7766554433', source:'Website', budget:'â‚¹1,00,000', owner:'Aabit', stage:'Hot', 
      remark:`Interested in contract, asked for detailed proposal by Friday.`, department:'domestic', dateAdded:'2025-02-14' },
    { name:'Alex Kumar', email:'alex@email.com', phone:'9988776655', source:'Referral', budget:'â‚¹15,000', owner:'Shivam', stage:'Cold', 
      remark:`Not interested right now â€“ call back in Q2.`, department:'abroad', dateAdded:'2025-02-01' }
];
const sampleGMeets = [
    { leadOwner:'Shivam', leadName:'Rahul Verma', meetDate:'2025-02-25 11:00 AM', agenda:'SEO Discussion', outcome:'Interested', proposalShared:'Yes', amountPitched:'â‚¹50,000' },
    { leadOwner:'Sarthak', leadName:'Priya Singh', meetDate:'2025-02-26 03:00 PM', agenda:'Social Media', outcome:'Decide next week', proposalShared:'No', amountPitched:'â‚¹25,000' },
    { leadOwner:'Aabit', leadName:'John Doe', meetDate:'2025-02-27 02:00 PM', agenda:'Contract', outcome:'Agreed', proposalShared:'Yes', amountPitched:'â‚¹1,00,000' }
];

// Helper: show toast messages
function showToast(msg, err) {
    const t = document.getElementById('toast'), m = document.getElementById('toast-message');
    m.textContent = msg; t.style.borderLeftColor = err ? '#ef4444' : '#3b82f6';
    t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000);
}

// Password modal handling
let selectedUser = null, selectedRole = null;
function showPasswordModal(u, r) { 
    selectedUser = u; selectedRole = r;
    document.getElementById('password-modal-subtitle').innerHTML = `Enter password for ${u}`;
    document.getElementById('password-modal').classList.add('active');
    document.getElementById('password-input').value = ''; 
    document.getElementById('password-input').focus();
}
function closePasswordModal() { document.getElementById('password-modal').classList.remove('active'); }
function verifyPassword() {
    const pwd = document.getElementById('password-input').value;
    if (selectedUser && USERS[selectedUser] && pwd === USERS[selectedUser].password) {
        closePasswordModal(); 
        setTimeout(() => login(selectedUser, USERS[selectedUser].role), 200);
    } else { 
        showToast('Incorrect password', true); 
        document.getElementById('password-input').value = ''; 
    }
}

function login(u, r) {
    currentUser = u; currentRole = r;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('current-user-display').textContent = u;
    document.getElementById('current-role-display').textContent = r;
    document.getElementById('welcome-user').textContent = u;
    document.getElementById('sidebar-role-label').innerText = r === 'Admin' ? 'Admin Dashboard' : `${u}'s Dashboard`;

    if (r === 'Admin') {
        // Admin sees department selector
        document.getElementById('dept-select-screen').style.display = 'flex';
        document.getElementById('department-dashboard').classList.add('hidden-pane');
    } else {
        // Team member: directly show Digital Sales dashboard, forced owner filter
        document.getElementById('dept-select-screen').style.display = 'none';
        document.getElementById('department-dashboard').classList.remove('hidden-pane');
        activeDepartment = 'digital'; // they belong to digital sales
        columnFilters.owner = currentUser; // enforce owner filter
        // update title
        document.getElementById('dept-dashboard-title').innerHTML = `ðŸ‘¤ ${u}'s Leads (Digital Sales) <span class="dept-indicator">DIGITAL</span>`;
    }
    document.getElementById('gmeet-pane').classList.add('hidden-pane');
    document.getElementById('pipeline-pane').classList.add('hidden-pane');
    
    loadAllSheets();  // fetch sheets based on user
    showToast(`Welcome, ${u}!`);
}

function logout() { location.reload(); }

// ========== LOAD SHEETS BASED ON USER ==========
function loadAllSheets() {
    let leadSheetPromises = [];
    let gmeetPromise = fetchCSV(GMEET_SHEET_URL, 'gmeet').then(meetings => gmeetMeetings = meetings).catch(() => gmeetMeetings = sampleGMeets);

    if (currentRole === 'Admin') {
        // Admin loads all department sheets + team member sheets
        leadSheetPromises = [
            fetchCSV(DIGITAL_SHEET_URL, 'digital').catch(() => []),
            fetchCSV(ABROAD_SHEET_URL, 'abroad').catch(() => []),
            fetchCSV(DOMESTIC_SHEET_URL, 'domestic').catch(() => []),
            fetchCSV(SARTHAK_SHEET_URL, 'digital').catch(() => []),  // assign department digital
            fetchCSV(AABID_SHEET_URL, 'digital').catch(() => [])     // assign department digital
        ];
    } else if (currentUser === 'Sarthak') {
        leadSheetPromises = [ fetchCSV(SARTHAK_SHEET_URL, 'digital').catch(() => []) ];
    } else if (currentUser === 'Aabid') {
        leadSheetPromises = [ fetchCSV(AABIT_SHEET_URL, 'digital').catch(() => []) ];
    }

    Promise.all(leadSheetPromises.concat(gmeetPromise))
        .then(results => {
            // Flatten leads from all fetched sheets
            leads = [];
            for (let i = 0; i < results.length - 1; i++) {
                if (Array.isArray(results[i])) leads.push(...results[i]);
            }
            // If no leads, fallback to samples
            if (leads.length === 0) leads = JSON.parse(JSON.stringify(sampleLeads));
            // For team members, ensure owner matches (sheet might have other owners, but we filter later)
            
            if (activeDepartment) {
                populateDropdowns();
                updateStatsAndTable();
            }
            showToast('Sheets loaded');
        })
        .catch(err => {
            console.error(err);
            showToast('Using sample data', true);
            leads = JSON.parse(JSON.stringify(sampleLeads));
            gmeetMeetings = JSON.parse(JSON.stringify(sampleGMeets));
            if (activeDepartment) {
                populateDropdowns();
                updateStatsAndTable();
            }
        });
}

// Helper to fetch a single CSV and parse it
function fetchCSV(url, department) {
    return new Promise((resolve, reject) => {
        if (!url || url.includes('2PACX-...')) {
            // If placeholder, return empty to use sample
            return resolve([]);
        }
        Papa.parse(url + (url.includes('?') ? '&' : '?') + 't=' + Date.now(), {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(result) {
                if (result.data && result.data.length > 0) {
                    if (department === 'gmeet') {
                        const meetings = result.data.map(row => ({
                            leadOwner: row['Lead Owner'] || row['lead owner'] || '',
                            leadName: row['Lead Name'] || row['lead name'] || '',
                            meetDate: row['G Meet Date'] || row['g meet date'] || '',
                            agenda: row['Agenda'] || row['agenda'] || '',
                            outcome: row['Outcome'] || row['outcome'] || '',
                            proposalShared: row['Proposal Shared'] || row['proposal shared'] || 'No',
                            amountPitched: row['Amount Pitched'] || row['amount pitched'] || 'â‚¹0'
                        }));
                        resolve(meetings);
                    } else {
                        const leadsFromSheet = result.data.map(row => ({
                            name: row['Name'] || row['name'] || 'Unnamed',
                            email: row['Email'] || row['email'] || '-',
                            phone: row['Phone'] || row['phone'] || '-',
                            source: row['Source'] || row['source'] || 'Direct',
                            budget: row['Budget'] || row['budget'] || '-',
                            owner: row['Lead Owner'] || row['lead owner'] || 'Unassigned',
                            stage: row['Stage'] || row['stage'] || 'New',
                            remark: row['Remark'] || row['remark'] || 'No remarks',
                            department: department,   // 'digital', 'abroad', 'domestic'
                            dateAdded: row['Date Added'] || row['date added'] || new Date().toISOString().slice(0,10)
                        }));
                        resolve(leadsFromSheet);
                    }
                } else {
                    resolve([]);
                }
            },
            error: function(err) {
                reject(err);
            }
        });
    });
}

// ========== FILTERING & UI ==========

function populateDropdowns() {
    if (!activeDepartment) return;
    let deptLeads = leads.filter(l => l.department === activeDepartment);
    // For team members, further restrict to their owner (though column filter already does)
    
    const sources = [...new Set(deptLeads.map(l => l.source).filter(Boolean))].sort();
    const owners = [...new Set(deptLeads.map(l => l.owner).filter(Boolean))].sort();
    const stages = [...new Set(deptLeads.map(l => l.stage).filter(Boolean))].sort();

    renderDropdown('source', sources);
    renderDropdown('owner', owners);
    renderDropdown('stage', stages);
}

function renderDropdown(field, values) {
    const dropdown = document.getElementById(`${field}-dropdown`);
    let html = `<div class="filter-dropdown-item p-2 hover:bg-gray-700 cursor-pointer" onclick="setColumnFilter('${field}', null)">All ${field}s</div>`;
    values.forEach(val => {
        const activeClass = columnFilters[field] === val ? 'bg-blue-600' : '';
        html += `<div class="filter-dropdown-item p-2 hover:bg-gray-700 cursor-pointer ${activeClass}" onclick="setColumnFilter('${field}', '${val.replace(/'/g, "\\'")}')">${val}</div>`;
    });
    dropdown.innerHTML = html;
}

function toggleDropdown(field) {
    // Team members cannot change owner filter
    if (currentRole === 'Team Member' && field === 'owner') {
        showToast('You can only view your own leads', true);
        return;
    }
    if (openDropdown) {
        document.getElementById(`${openDropdown}-dropdown`).classList.remove('show');
    }
    const current = document.getElementById(`${field}-dropdown`);
    if (openDropdown === field) {
        current.classList.remove('show');
        openDropdown = null;
    } else {
        current.classList.add('show');
        openDropdown = field;
    }
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.filterable-th')) {
        if (openDropdown) {
            document.getElementById(`${openDropdown}-dropdown`).classList.remove('show');
            openDropdown = null;
        }
    }
});

function setColumnFilter(field, value) {
    columnFilters[field] = value;
    document.getElementById(`${field}-dropdown`).classList.remove('show');
    openDropdown = null;
    applyFilters();
}

function selectDepartment(dept) {
    if (currentRole === 'Team Member' && dept !== 'digital') {
        showToast('You only have access to Digital Sales', true);
        return;
    }
    activeDepartment = dept;
    // Reset filters but preserve owner for team members
    searchTerm = ''; filterDate = null; 
    if (currentRole !== 'Team Member') {
        columnFilters = { owner: null, source: null, stage: null };
    } else {
        columnFilters = { owner: currentUser, source: null, stage: null }; // owner forced
    }
    document.getElementById('searchInput').value = '';
    document.getElementById('dateFilter').value = '';
    
    document.getElementById('dept-select-screen').style.display = 'none';
    document.getElementById('department-dashboard').classList.remove('hidden-pane');
    document.getElementById('gmeet-pane').classList.add('hidden-pane');
    document.getElementById('pipeline-pane').classList.add('hidden-pane');
    
    const titles = { digital:'Digital Sales', abroad:'Study Abroad', domestic:'Domestic Sales' };
    let title = titles[dept];
    if (currentRole === 'Team Member') title = `ðŸ‘¤ ${currentUser}'s Leads (Digital Sales)`;
    document.getElementById('dept-dashboard-title').innerHTML = title + ' <span class="dept-indicator">' + dept.toUpperCase() + '</span>';
    
    setTimeout(() => {
        populateDropdowns();
        updateStatsAndTable();
    }, 50);
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (event && event.currentTarget) event.currentTarget.classList.add('active');
}

function showGMeet() {
    activeDepartment = null;
    document.getElementById('dept-select-screen').style.display = 'none';
    document.getElementById('department-dashboard').classList.add('hidden-pane');
    document.getElementById('gmeet-pane').classList.remove('hidden-pane');
    document.getElementById('pipeline-pane').classList.add('hidden-pane');
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.innerText.includes('G Meet')) item.classList.add('active');
    });
    
    renderGMeetTable();
}

function showPipeline() {
    activeDepartment = null;
    document.getElementById('dept-select-screen').style.display = 'none';
    document.getElementById('department-dashboard').classList.add('hidden-pane');
    document.getElementById('gmeet-pane').classList.add('hidden-pane');
    document.getElementById('pipeline-pane').classList.remove('hidden-pane');
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.innerText.includes('Pipeline')) item.classList.add('active');
    });
    
    renderPipeline();
}

function filterLeads() {
    if (!activeDepartment) return [];
    let filtered = leads.filter(l => l.department === activeDepartment);

    if (searchTerm.trim() !== '') {
        const term = searchTerm.toLowerCase();
        filtered = filtered.filter(l => 
            l.name.toLowerCase().includes(term) ||
            l.phone.includes(term) ||
            l.email.toLowerCase().includes(term)
        );
    }

    if (filterDate) {
        const filterTime = filterDate.getTime();
        filtered = filtered.filter(l => {
            if (!l.dateAdded) return true;
            const leadTime = new Date(l.dateAdded).getTime();
            return leadTime >= filterTime;
        });
    }

    // Apply column filters, but for team members owner is forced
    if (columnFilters.owner) filtered = filtered.filter(l => l.owner === columnFilters.owner);
    if (columnFilters.source) filtered = filtered.filter(l => l.source === columnFilters.source);
    if (columnFilters.stage) filtered = filtered.filter(l => l.stage === columnFilters.stage);

    return filtered;
}

function updateStatsAndTable() {
    const filtered = filterLeads();
    const total = filtered.length;
    const hot = filtered.filter(l => l.stage.toLowerCase()==='hot').length;
    const warm = filtered.filter(l => l.stage.toLowerCase()==='warm').length;
    const cold = filtered.filter(l => l.stage.toLowerCase()==='cold').length;

    document.getElementById('dept-stats').innerHTML = `
        <div class="stats-card"><p class="text-gray-400 text-sm">Total Leads</p><p class="text-3xl font-bold text-white mt-2">${total}</p></div>
        <div class="stats-card border-l-4 border-l-red-500"><p class="text-gray-400 text-sm">Hot</p><p class="text-3xl font-bold text-red-400 mt-2">${hot}</p></div>
        <div class="stats-card border-l-4 border-l-yellow-500"><p class="text-gray-400 text-sm">Warm</p><p class="text-3xl font-bold text-yellow-400 mt-2">${warm}</p></div>
        <div class="stats-card border-l-4 border-l-blue-500"><p class="text-gray-400 text-sm">Cold</p><p class="text-3xl font-bold text-blue-400 mt-2">${cold}</p></div>
    `;

    let chipHtml = '';
    if (columnFilters.owner && currentRole !== 'Team Member') chipHtml += `<span class="filter-chip"><i class="fas fa-user"></i> Owner: ${columnFilters.owner} <i class="fas fa-times-circle ml-1 cursor-pointer" onclick="clearFilter('owner')"></i></span>`;
    else if (columnFilters.owner && currentRole === 'Team Member') chipHtml += `<span class="filter-chip bg-blue-800"><i class="fas fa-user"></i> My Leads (${columnFilters.owner}) </span>`; // non-removable
    if (columnFilters.source) chipHtml += `<span class="filter-chip"><i class="fas fa-tag"></i> Source: ${columnFilters.source} <i class="fas fa-times-circle ml-1 cursor-pointer" onclick="clearFilter('source')"></i></span>`;
    if (columnFilters.stage) chipHtml += `<span class="filter-chip"><i class="fas fa-chart-simple"></i> Stage: ${columnFilters.stage} <i class="fas fa-times-circle ml-1 cursor-pointer" onclick="clearFilter('stage')"></i></span>`;
    document.getElementById('active-filter-chip').innerHTML = chipHtml;

    const tbody = document.getElementById('dept-table-body');
    tbody.innerHTML = '';
    if (filtered.length===0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No leads match filters</td></tr>';
    } else {
        filtered.forEach(lead => {
            let stageClass = '';
            if (lead.stage.toLowerCase() === 'hot') stageClass = 'status-hot';
            else if (lead.stage.toLowerCase() === 'warm') stageClass = 'status-warm';
            else if (lead.stage.toLowerCase() === 'cold') stageClass = 'status-cold';
            else stageClass = 'bg-gray-700 text-gray-300';

            const preview = lead.remark.split('\n').map(s => s.trim()).filter(s=>s).join(' â€¢ ') || lead.remark.substring(0,60);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="font-medium">${lead.name}</td>
                <td>${lead.email}</td>
                <td>${lead.phone}</td>
                <td><span class="source-badge">${lead.source}</span></td>
                <td>${lead.budget}</td>
                <td>${lead.owner}</td>
                <td><span class="status-badge ${stageClass}">${lead.stage}</span></td>
                <td>
                    <div class="remark-cell">
                        <span class="remark-preview">${preview}</span>
                        <button class="read-more-btn" onclick='showLeadPopup(${JSON.stringify(lead).replace(/'/g, "\\'")})'>Read</button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
}

function clearFilter(field) {
    if (currentRole === 'Team Member' && field === 'owner') {
        showToast('Cannot remove owner filter', true);
        return;
    }
    columnFilters[field] = null;
    applyFilters();
    populateDropdowns();
}

function parseRemarkTimeline(remarkStr) {
    if (!remarkStr || remarkStr.trim() === '') return [];
    const lines = remarkStr.split('\n').map(l => l.trim()).filter(l => l !== '');
    return lines.map(line => {
        return {
            date: line.split(' ')[0] + ' ' + (line.split(' ')[1] || ''),
            text: line
        };
    });
}

function showLeadPopup(lead) {
    const grid = document.getElementById('popup-lead-details');
    grid.innerHTML = `
        <span class="detail-label">Name</span><span class="detail-value">${lead.name}</span>
        <span class="detail-label">Email</span><span class="detail-value">${lead.email}</span>
        <span class="detail-label">Phone</span><span class="detail-value">${lead.phone}</span>
        <span class="detail-label">Source</span><span class="detail-value">${lead.source}</span>
        <span class="detail-label">Budget</span><span class="detail-value">${lead.budget}</span>
        <span class="detail-label">Owner</span><span class="detail-value">${lead.owner}</span>
        <span class="detail-label">Stage</span><span class="detail-value"><span class="status-badge ${lead.stage==='Hot'?'status-hot':lead.stage==='Warm'?'status-warm':'status-cold'}">${lead.stage}</span></span>
        <span class="detail-label">Dept</span><span class="detail-value">${lead.department}</span>
        <span class="detail-label">Date added</span><span class="detail-value">${lead.dateAdded || 'â€”'}</span>
    `;

    const timelineEntries = parseRemarkTimeline(lead.remark);
    const container = document.getElementById('popup-remark-container');
    if (timelineEntries.length === 0) {
        container.innerHTML = '<div class="text-gray-500 italic p-4">No remarks</div>';
    } else {
        let timelineHtml = '';
        timelineEntries.forEach((entry, idx) => {
            timelineHtml += `
                <div class="timeline-item">
                    <div class="timeline-badge">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-date"><i class="far fa-clock"></i> ${entry.date}</div>
                        <div class="timeline-text">${entry.text}</div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = timelineHtml;
    }

    document.getElementById('lead-popup').classList.add('active');
}

function applyFilters() {
    searchTerm = document.getElementById('searchInput').value;
    const dateStr = document.getElementById('dateFilter').value;
    filterDate = dateStr ? new Date(dateStr + 'T00:00:00') : null;
    // For team members, ensure owner filter is always applied
    if (currentRole === 'Team Member') {
        columnFilters.owner = currentUser;
    }
    updateStatsAndTable();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('dateFilter').value = '';
    searchTerm = '';
    filterDate = null;
    if (currentRole === 'Team Member') {
        columnFilters = { owner: currentUser, source: null, stage: null };
    } else {
        columnFilters = { owner: null, source: null, stage: null };
    }
    updateStatsAndTable();
    populateDropdowns();
}

function renderGMeetTable() {
    let meetings = gmeetMeetings;
    // Filter for team members
    if (currentRole === 'Team Member') {
        meetings = meetings.filter(m => m.leadOwner === currentUser);
    }
    const tbody = document.getElementById('gmeet-table-body');
    tbody.innerHTML = '';
    if (!meetings.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No meetings scheduled</td></tr>';
        return;
    }
    meetings.forEach(m => {
        const proposalClass = m.proposalShared === 'Yes' ? 'proposal-yes' : 'proposal-no';
        tbody.innerHTML += `<tr>
            <td>${m.leadOwner}</td><td>${m.leadName}</td><td>${m.meetDate}</td>
            <td>${m.agenda}</td><td>${m.outcome}</td>
            <td><span class="proposal-badge ${proposalClass}">${m.proposalShared}</span></td>
            <td>${m.amountPitched}</td>
        </tr>`;
    });
}

function renderPipeline() {
    let meetings = gmeetMeetings;
    if (currentRole === 'Team Member') {
        meetings = meetings.filter(m => m.leadOwner === currentUser);
    }
    const pipelineByOwner = {};
    let totalPipeline = 0;
    meetings.forEach(meet => {
        const numeric = parseFloat(meet.amountPitched.replace(/[^0-9.]/g, '')) || 0;
        const owner = meet.leadOwner || 'Unassigned';
        pipelineByOwner[owner] = (pipelineByOwner[owner] || 0) + numeric;
        totalPipeline += numeric;
    });

    const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
    document.getElementById('total-pipeline-amount').innerText = formatter.format(totalPipeline).replace('â‚¹', 'â‚¹');

    const grid = document.getElementById('pipeline-owner-grid');
    grid.innerHTML = '';
    const owners = Object.keys(pipelineByOwner).sort();
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
    owners.forEach((owner, idx) => {
        const amount = pipelineByOwner[owner];
        grid.innerHTML += `
            <div class="pipeline-owner-card" style="border-left-color: ${colors[idx % colors.length]}">
                <div class="text-gray-300 text-sm mb-1">${owner}</div>
                <div class="text-2xl font-bold text-white">${formatter.format(amount).replace('â‚¹', 'â‚¹')}</div>
                <div class="text-gray-500 text-xs mt-2">pipeline value</div>
            </div>
        `;
    });

    const detailBody = document.getElementById('pipeline-detail-table');
    detailBody.innerHTML = '';
    meetings.forEach(meet => {
        detailBody.innerHTML += `<tr><td>${meet.leadOwner}</td><td>${meet.leadName}</td><td>${meet.amountPitched}</td><td>${meet.meetDate}</td><td>${meet.outcome}</td></tr>`;
    });
}

function exportToExcel() {
    // same as before, but for team members only their data
    if (activeDepartment) {
        const filtered = filterLeads();
        if (filtered.length===0 && gmeetMeetings.length===0) { showToast('No data', true); return; }
        const rows = [];
        rows.push(`${activeDepartment.toUpperCase()} DEPARTMENT LEADS`);
        rows.push(['Name','Email','Phone','Source','Budget','Owner','Stage','Remark','DateAdded'].join(','));
        filtered.forEach(l => rows.push(`"${l.name}","${l.email}","${l.phone}","${l.source}","${l.budget}","${l.owner}","${l.stage}","${l.remark}","${l.dateAdded || ''}"`));
        rows.push(''); rows.push('G MEET DATA');
        rows.push(['Lead Owner','Lead Name','Date','Agenda','Outcome','Proposal','Amount'].join(','));
        let meetings = gmeetMeetings;
        if (currentRole === 'Team Member') meetings = meetings.filter(m => m.leadOwner === currentUser);
        meetings.forEach(m => rows.push(`"${m.leadOwner}","${m.leadName}","${m.meetDate}","${m.agenda}","${m.outcome}","${m.proposalShared}","${m.amountPitched}"`));
        const blob = new Blob([rows.join('\n')],{type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${currentUser}_export_${Date.now()}.csv`; a.click();
        showToast('Exported');
    } else {
        // from gmeet or pipeline view
        let meetings = gmeetMeetings;
        if (currentRole === 'Team Member') meetings = meetings.filter(m => m.leadOwner === currentUser);
        if (meetings.length===0) { showToast('No G Meet data', true); return; }
        const rows = [];
        rows.push('G MEET DATA');
        rows.push(['Lead Owner','Lead Name','Date','Agenda','Outcome','Proposal','Amount'].join(','));
        meetings.forEach(m => rows.push(`"${m.leadOwner}","${m.leadName}","${m.meetDate}","${m.agenda}","${m.outcome}","${m.proposalShared}","${m.amountPitched}"`));
        const blob = new Blob([rows.join('\n')],{type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `gmeet_export_${Date.now()}.csv`; a.click();
        showToast('Exported');
    }
}

document.addEventListener('keydown', e => { if(e.key==='Escape') document.querySelectorAll('.modal-overlay.active').forEach(m=>m.classList.remove('active')); });
setInterval(loadAllSheets, 300000); // refresh every 5 minutes
</script>
</body>
</html>